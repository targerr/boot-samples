# Seata

> Seata是一款开源的分布式事务解决方案,致力于在微服务架构下提供高性能和简单易用的分布式事务服务

## 什么是分布式事务？

分布式事务：顾名思义就是再分布式系统下，产生的事务；单体应用下是不存在分布式事务的。

## 典型的下单流程

订单系统和商品系统都是自己的数据库，他们的数据库是独立的，没有公用一个数据库；

![image.png](https://upload-images.jianshu.io/upload_images/4994935-2860c21483e8eac7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 订单调用商品系统

调用协议不限，可以是RPC 或者 HTTP

![image.png](https://upload-images.jianshu.io/upload_images/4994935-4eefe83f589abd63.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### 下单流程

下订单->减库存-> 改订单状态

- 第1步： 调用库存的接口
- 第2步： 商品系统要操作数据库了，要减库存嘛，所以他要操作自己的数据库，数据库要更新库存减掉之后呢
- 第3步： 成功的减掉之后要发回一个信息给订单系统告诉他库存减成功了
- 第4步：然后订单系统才会创建订单，把这个订单写到数据库里面去写到订单数据库里面去

<span style="color: darkcyan; "> 
 很常见，很简单的一个过程啊，那我们来想什么情况下会造成数据的一个错乱呢，我们看第3步跟第4步之间这一部分代码其实都在订单系统里面，就是订单系统拿到了成功的结果，然后还要去创建订单了，这部分代码呢是在订单系统里面的，假如第3步和第4步之间抛出了一个异常就是发生了异常了，因为这中间你可能还要做其他的事情，又或者呢第4步创建订单的时候直接失败了，这种情况也是一样的啊，都会导致一种结果，什么结果呢，订单不会被创建数据库里面没有这条订单，因为已经抛出了一个异常了，但是商品那边库存被扣掉了，你想想第3步他已经返回了扣扣成成功的结果了，所以第三步和第四步发生一个异常，商品的库存是不能被扣减的，要被还原过去，订单都没下成功怎么能扣库存呢
</span>

 ---

## 核心组件介绍

- 事务协调器 TC

> 维护全局和分支事务的状态,指示全局提交或者回滚

- 事务管理者 TM

> 开启,提交或者回滚一个全局事务.

- 资源管理者

> 管理执行分支事务的那些资源,向TC注册分支事务,上报事务状态,控制事务的提交和回滚

## 重要机制

### （1）全局事务的回滚是如何实现的呢？

> Seata有一个重要的机制: 回滚日志

- 每个分支事务对应的数据库中都需要一个回滚日志表 UNDO_LOG,再真正修改数据之前,都会先记录修改器的记录值,方便回滚

- 再收到回滚请求后,就会根据UNDO_LOG生成的回滚日志操作SQL语句执行

- 如果收到的是提交请求,就把UNDO_LOG对应的日志删除

### （2）RM 是怎么自动和 TC 交互的？

> 是通过监控拦截JDBC实现的，例如监控到开启本地事务了，就会自动向 TC 注册、生成回滚日志、向 TC 汇报执行结果。

### （3）二阶段回滚失败怎么办？

> 例如 TC 命令各个 RM 回滚的时候，有一个微服务挂掉了，那么所有正常的微服务也都不会执行回滚，当这个微服务重新正常运行后，TC 会重新执行全局回滚。


---

### 具体工作过程

![image.png](https://upload-images.jianshu.io/upload_images/4994935-d05ad5b1ae1cc9ec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- TM请求TC,开始一个新的全局事务,TC会为这个全局事务生成一个XID.
- XID通过微服务的调用链传递到其他微服务.
- RM把本地事务作为这个XID的分布式事务注册到TC
- TM请求TC对这个XID进行提交和回滚
- TC 指挥这个 XID 下面的所有分支事务进行提交、回滚。

### 大白话叙述

TC: 阳哥授课老师    
TM: 班主任 RM: 同学们

- 班主任向授课老师说是否可以开班了,如果可以就开一个班级为XXXX的办号的网络教室
- 班主任拿个这个班号,让同学们加入到这个班号的微信
- 同学们都进入到授课老师的微信群
- 同学们都到齐就开课
- 结课了,就下课提交

#### [官网地址](http://seata.io/zh-cn/)

![image.png](https://upload-images.jianshu.io/upload_images/4994935-208051f56c741c71.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

> 一次业务操作需要垮多个数据源或需要垮多个系统进行远程调用,就会产生分布式事务问题

### [分布式三种模式详解](https://seata.io/zh-cn/blog/seata-at-tcc-saga.html)

